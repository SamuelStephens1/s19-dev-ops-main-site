---
/** Render on request; do not prerender this dynamic route */
export const prerender = false;

/** slug can be "a/b/c" or ["a","b","c"] */
const seg = Astro.params.slug;
const slug = Array.isArray(seg) ? seg.join('/') : (seg ?? '');

/** Eagerly import every MD/MDX file under src/content/blog */
const files = import.meta.glob('../../content/blog/**/*.{md,mdx}', { eager: true });

/** Normalize slugs like "folder/post" from file paths */
const entries = Object.entries(files).map(([path, mod]) => {
  const norm = path
    .replace(/\\/g, '/')                             // windows â†’ forward slashes
    .replace(/^.*\/content\/blog\//, '')             // strip leading dirs
    .replace(/\.(md|mdx)$/, '');                     // drop extension
  return { slug: norm, mod: mod as any };
});

const match = entries.find(e => e.slug === slug);

if (!match) {
  return new Response('Not found', { status: 404 });
}

/** Astro MD/MDX modules expose { default: Content, frontmatter } */
const { default: Content, frontmatter } = match.mod;
---

<article style="max-width: 800px; margin: 4rem auto; padding: 0 1rem;">
  <h1>{frontmatter?.title ?? slug}</h1>
  {frontmatter?.description && <p style="opacity:.7">{frontmatter.description}</p>}
  <Content />
</article>
